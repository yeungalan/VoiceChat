<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js" integrity="sha512-pumBsjNRGGqkPzKHndZMaAG+bir374sORyzM3uulLV14lN5LyykqNk8eEeUlUkB3U0M4FApyaHraT65ihJhDpQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  </head>
  <body>
    <div class="container">
        <h1>Hello, world!</h1>
        <p id="count">#</p>
        <button type="button" id="record" class="btn btn-primary">Connect to Channel - 1</button>
        <audio id="audio-player"></audio>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
    <script>
        var count = 0;
        var socket = new WebSocket(getWebSocketEndpoint() + '/ws/channel-1');
        var mediaStream;
        //var started = false;

        function startStream() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    mediaStream = stream;
                    var mediaRecorder;
                    var options = { mimeType: 'audio/webm' };
                    mediaRecorder = new MediaRecorder(mediaStream, options);

                    mediaRecorder.addEventListener('dataavailable', function(event) {
                        if (event.data.size > 0) {
                            const reader = new FileReader();
                            reader.onload = function() {
                                const base64Data = reader.result.split(',')[1];
                                socket.send(base64Data);
                            };
                            reader.readAsDataURL(event.data);
                        }
                    });

                    mediaRecorder.start();
                    setTimeout(function(){mediaRecorder.stop();startStream(); }, 500);
                    console.log("OK");
            });
        }

        document.getElementById('record').addEventListener('click', function() {
            startStream();
        });


        
        socket.addEventListener('message', function(event) {
            count++;
            $("#count").text(count);
			const base64Data = event.data;
			const binaryData = atob(base64Data);
			const audioData = new Uint8Array(binaryData.length);
			for (let i = 0; i < binaryData.length; i++) {
				audioData[i] = binaryData.charCodeAt(i);
			}
			const audioBlob = new Blob([audioData.buffer], { type: 'audio/webm' });

            
			const audioUrl = URL.createObjectURL(audioBlob);
			const audioElement = new Audio(audioUrl);
			audioElement.play();
        });
        
        // from arozos, collabed project
        function getWebSocketEndpoint(){
            let protocol = "wss://";
            if (location.protocol !== 'https:') {
                protocol = "ws://";
            }
            let port = window.location.port;
            if (window.location.port == ""){
                if (location.protocol !== 'https:') {
                    port = "80";
                }else{
                    port = "443";
                }
                
            }
            let wsept = (protocol + window.location.hostname + ":" + port);
            return wsept;
        }
    </script>
  </body>
</html>